<template>
    <div class="app-main" :style="{'width':'100%','height':'100%'}" @click="closeDefault">
        <div class="layout" :style="{'width':'100%','height':'100%'}">
            <!-- 头部 -->
            <top></top>
            <Row type="flex" class="setHeight">
                <!-- 侧边栏树结构 -->
                <i-col span="5" class="layout-menu-left">
                    <div class="tips-pop box-align start-box box-pack box-orient">
                        <div class="tips-icon" @mouseover="togleshow" @mouseout="toglehide"></div>
                        <transition name="togoole">
                            <ul class="tips-dropdown-menu" v-if="isTogoole">
                                <li class="tips-dropdown-item start-box box-align">
                                    <div class="tree-icons-1" style="margin:0 10px;"></div>
                                    <p>地方党委</p>
                                </li>
                                <li class="tips-dropdown-item start-box box-align">
                                    <div class="tree-icons-2" style="margin:0 10px;"></div>
                                    <p>党组</p>
                                </li>
                                <li class="tips-dropdown-item start-box box-align">
                                    <div class="tree-icons-3" style="margin:0 10px;"></div>
                                    <p>党委、工委</p>
                                </li>
                                <li class="tips-dropdown-item start-box box-align">
                                    <div class="tree-icons-4" style="margin:0 10px;"></div>
                                    <p>党总支</p>
                                </li>
                                <li class="tips-dropdown-item start-box box-align">
                                    <div class="tree-icons-5" style="margin:0 10px;"></div>
                                    <p>党支部</p>
                                </li>
                                <li class="tips-dropdown-item start-box box-align">
                                    <div class="tree-icons-6" style="margin:0 10px;"></div>
                                    <p>党小组</p>
                                </li>
                            </ul>
                        </transition> 
                    </div>
                    <Slide ref="slide" 
                        @reflashList="reflashList" 
                        @getnode="getnode"
                        @slideDown="slideDown"
                        :url="url"
                        :openitem="openitem"
                        :currentnode="currentnode"
                        :openlist="openlist"
                        >
                    </Slide>
                </i-col>
                <i-col span="19">
                    <!-- 表单主结构 -->
                    <div class="layout-content" style="position:realtive;">
                        <div class="content-padding">
                            <!-- 搜索和过滤 -->
                            <div class="search-filter start-box box-align">
                                <div class="search-content start-box box-align box-flex">
                                    <Button type="ghost" @click="addUnit">新增下级机构</Button>
                                    <Button type="ghost">排序</Button>
                                    <Button type="ghost">信息校核</Button>
                                </div>
                                <div class="set-config">
                                    <Select style="width:100px" placeholder="列表设置">
                                         <CheckboxGroup  v-model="social">
                                            <Checkbox v-for="item in cityList" :key="item.value" :label="item.key" :disabled="item.disabled" style="display:block;border-bottom: 1px solid #ddd; padding:3px 5px; margin-right:0px;"> {{item.title}} </Checkbox>
                                        </CheckboxGroup>
                                    </Select>
                                    <Button type="ghost" :style="{'background':'#fff'}" @click="reflash">刷新</Button>
                                    <Button type="ghost" :style="{'background':'#fff'}">导出excel</Button>
                                </div>
                            </div>
                            <Table 
                                :style="{'marginTop':'20px', 'height':'calc(100% - 92px)', 'height': '-webkit-calc(100% - 92px)'}" 
                                border 
                                :columns="headers" 
                                :data="lists" 
                                stripe 
                                highlight-row 
                                @on-row-click="goDetail"></Table>
                        </div>
                    </div>
                    <transition name="slides">
                        <Info v-if="slideBar"></Info>
                    </transition>

                    <transition name="slides">
                        <router-view></router-view>
                    </transition>
                </i-col>
            </Row>
        </div>
    </div>
</template>
<script>
    import top from '@/components/top.vue'
    import Slide from '@/components/slide.vue'

    export default {
        name: 'unitManage',
        data() {
            return {
                url: '/v1/trees/list',
                openitem: [],
                openlist: [],
                isTogoole: false,
                currentnode: '',
                searchString: '',
                slideBar: false,
                social:['name', 'partycode', 'type', 'sec', 'items', 'endtime'],
                cityList: [
                    {
                        title: '单位/机构名称',
                        key: 'name',
                        disabled: true,
                    },
                    {
                        title: '类型',
                        key: 'partycode',
                        disabled: true,
                    },
                    {
                        title: '隶属关系',
                        key: 'type',
                        disabled: false,
                    },
                    {
                        title: '性质类别',
                        key: 'sec',
                        disabled: false,
                    },
                    {
                        title: '所属行业',
                        key: 'items',
                        disabled: false,
                    },
                    {
                        title: '信息完整度',
                        key: 'endtime',
                        disabled: false,
                    }
                ],
                soltname: 'mainContent',
                //表单header
                headers: [
                    {
                        title: '单位/机构名称',
                        key: 'name',
                        sortable: true,
                    },
                    {
                        title: '类型',
                        key: 'partycode',
                        sortable: true,
                    },
                    {
                        title: '隶属关系',
                        key: 'type',
                        sortable: true,
                    },
                    {
                        title: '性质类别',
                        key: 'sec',
                        sortable: true,
                    },
                    {
                        title: '所属行业',
                        key: 'items',
                        sortable: true,
                    },
                    {
                        title: '信息完整度',
                        key: 'endtime',
                        sortable: true,
                    }
                ],
                copyHeader:  [
                    {
                        title: '单位/机构名称',
                        key: 'name',
                        sortable: true,
                    },
                    {
                        title: '类型',
                        key: 'partycode',
                        sortable: true,
                    },
                    {
                        title: '隶属关系',
                        key: 'type',
                        sortable: true,
                    },
                    {
                        title: '性质类别',
                        key: 'sec',
                        sortable: true,
                    },
                    {
                        title: '所属行业',
                        key: 'items',
                        sortable: true,
                    },
                    {
                        title: '信息完整度',
                        key: 'endtime',
                        sortable: true,
                    }
                ],
                //表单数据
                lists: [],
                remberId: '', //记住点击的列
                remberRow: {}
            }
        },
        computed: {
            isRef() {
                return this.$store.state.strictRefalsh;
            },
            ishis() {
                return this.$store.state.isHistory;
            }
        },
        watch: {
            social(newD, oldD) {
                let that = this;
                if (newD.length > oldD.length) {
                    let oldSet = new Set(oldD);
                    let comp = newD.filter(v => {return !oldSet.has(v)});
                    let serArr = this.searchStr(comp[0], this.copyHeader, 'object');
                    let seri = this.searchStr(comp[0], this.copyHeader);
                    that.headers.splice(seri, 0, serArr);
                } else if(newD.length < oldD.length) {
                    let newSet = new Set(newD);
                    let comp = oldD.filter(v => {return !newSet.has(v)});
                    let seri = this.searchStr(comp[0], this.headers);
                    that.headers.splice(seri, 1);
                }
            },
            isRef(newD, oldD) {
                if (newD != oldD) {
                    this.getList(this.$store.state.remberId, 1);
                };
            },
            ishis(v) {
                if (v) {
                    this.$nextTick(function() {
                       $('.gobalhidden').show();
                    })
                } else {
                    this.$nextTick(function() {
                       $('.gobalhidden').hide(); 
                    })
                }
            }
        },
        components: {
            top,
            Slide,
        },
        methods: {
            addUnit() {
                let that = this;
                if (this.$route.name === 'unit') {
                    return;
                };
                this.$router.push({name:'unitNew'})
            },
            togleshow() {
                this.isTogoole = true;
            },
            toglehide() {
                this.isTogoole = false;
            },
            slideDown() {
                console.log('jieshu')
            },
            searchStr(str, ser, returnType) {
                for (var i = 0; i < ser.length; i++) {
                    if (ser[i].key == str) {
                        if (returnType == 'object') {
                            return ser[i];
                        } else {
                           return i; 
                        }
                    } else if(ser[i].key != str && i == (ser.length -1) ) {
                        return null;
                    }
                };
            },
            closeDefault() {
                if (this.$route.name == 'unit' || this.$route.name == 'group') {
                    this.$router.go(-1);
                };
            },
            //查看详情
            goDetail(row) {
                event.stopPropagation();
                if (this.$route.name !== 'unitManage') {
                    if (this.remberId == row.id) {
                        return;
                    };
                   this.$router.replace({name:'unit',params:{id: row.id}})
                   this.remberId = row.id;
                } else {
                    this.remberId = row.id;
                    this.$router.push({name:'unit',params:{id: row.id}})
                }
                this.$store.commit('setSlideBar', {'isShow': false, sliderow: row});
            },

            eidt(item) {
                this.$router.push({path: '/cms/singleVideoAdd', query: {id: item.row.id}});
            },
            // tree emit events（events up）
            reflashList(item) {
                if (/^unit$/.test(this.$route.name)) {
                    this.$router.go(-1);
                }
                this.lists = [];
                this.getList(item.id, 1)
            },
            // main list
            getList(id, type) {
                let that = this;
                let qs = require('qs');
                this.axios({
                    method: 'get',
                    url: '/v1/dept/list',
                    params: {
                        dept_id: id,
                        opt: type ? type : 0,
                    }
                })
                .then(res => {
                    let needData = res.data;
                    if (needData.code == 200) {
                        that.lists = [];
                        needData.data.forEach(item => {
                            that.lists.push(item);
                        });
                    } else {
                        that.$Message.error(needData.msg);
                    }
                })
                .catch(err => {
                    this.$Message.error('网络请求异常');
                })    
            },
            goPage(p) {
                this.lists = [];
                this.page_index = p;
            },
            getnode(node) {
                // console.log(node)
            },
            reflash() {
                 this.openlist = [798, 797, 792, 796];
            }

        },
        created() {
                
        },
        mounted() {       
            this.getList(68);
        },
    }
</script>
<style scoped>
    .togoole-enter-active {
        transition: all 0.3s;
    }
    .togoole-leave-active {
        transition: all 0.3s;
    }
    .slides-enter-active {
      transition: all .3s ease;
    }
    .slides-leave-active {
      transition: all .8s ease;
    }
    .slides-enter, .slides-leave-to
    {
      transform: translateX(800px);
      opacity: 0;
    }
</style>