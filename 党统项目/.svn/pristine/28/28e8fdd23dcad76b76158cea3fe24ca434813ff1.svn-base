<template>
	<Row type="flex">
		<i-col span="5" class="layout-menu-left start-box pack-center" style="">
			<div class="layout-header start-box box-align" :style="{'backgroundColor':'#db240b', 'width':'100%', 'paddingLeft': '15px'}">
				<div class="start-box">
					<div class="bg"></div>
					<p style="font-size: 18px;">天津市党内统计信息系统</p>
				</div>
			</div>
		</i-col>
		<i-col span="19">
			<Modal
		      v-model="modal1"
		      title="修改密码"
		      width="650"
		      :loading="loading"
		      :mask-closable="false"
		      class-name="max-height vertical-center-modal"
		      @on-ok="handleSubmit('OrganizationeForm')"
		      @on-cancel="cancel">
		      <Row>
		        <Form ref="OrganizationeForm" :model="OrganizationeForm"  :label-width="150" :rules="ruleValidate">
		          <Col span="16">
		          <FormItem label="原密码：" prop="orignpwd">
		            <Input v-model="OrganizationeForm.orignpwd" type="password" placeholder="请输入原密码"></Input>
		          </FormItem>
		          <FormItem label="新密码：" prop="pwd">
		            <Input v-model="OrganizationeForm.pwd" type="password" placeholder="请输入新密码"></Input>
		          </FormItem>
		          <FormItem label="确定新密码：" prop="newpwd">
		            <Input v-model="OrganizationeForm.newpwd" type="password" placeholder="请输入"></Input>
		          </FormItem>
		          </Col>
		        </Form>
		      </Row>
		    </Modal>
		    <Modal
		      v-model="modal2"
		      title="切换角色"
		      width="650"
		      :loading="loading"
		      :mask-closable="false"
		      class-name="max-height vertical-center-modal"
		      @on-ok="handleSubmit2('OrganizationeForm2')"
		      @on-cancel="cancel">
		      <Row>
		        <Form ref="OrganizationeForm2" :model="OrganizationeForm2"  :label-width="150" :rules="ruleValidate2">
		          	<RadioGroup v-model="OrganizationeForm2.radio">
		                <Radio :label="item.id" style="display:block; margin: 8px;" v-for="item in lists" :key="item.id">{{item.full_name}}</Radio>
		            </RadioGroup>
		        </Form>
		      </Row>
		    </Modal>
			<div class="top-bar start-box">
				<!-- 一级导航 -->
				<div class="nav-manage start-box box-align box-flex">
					<div class="drown-outer start-box box-align">
						<Dropdown trigger="click" style="color:#fff;margin: 0 20px"  @on-click="routeTo">
					        <a href="javascript:void(0)" style="font-size: 14px;color: #fff;">
					            组织管理
					            <Icon type="arrow-down-b"></Icon>
					        </a>
					        <Dropdown-menu slot="list" class="nav-item">
					            <Dropdown-item name="/orgManage/0">党组织管理</Dropdown-item>
					            <Dropdown-item  name="/unitManage">单位管理</Dropdown-item>
					        </Dropdown-menu>
					    </Dropdown>	
					</div>
					<div class="drown-outer start-box box-align">
						<Dropdown trigger="click" style="margin:0 20px" @on-click="routeTo">
					        <a href="javascript:void(0)">
					            人员管理
					            <Icon type="arrow-down-b"></Icon>
					        </a>
					        <Dropdown-menu slot="list"  class="nav-item">
					            <Dropdown-item name="/dangyuan">党员管理</Dropdown-item>
					            <Dropdown-item name="/applicantManage">申请人管理</Dropdown-item>
					            <Dropdown-item name="/historyManage">历史人员管理</Dropdown-item>
					        </Dropdown-menu>
					    </Dropdown>
					</div>
				    <div class="drown-outer start-box box-align" >
					    <Dropdown trigger="click" style="margin:0 20px" @on-click="routeTo">
					        <a href="javascript:void(0)">
					            业务工作
					            <Icon type="arrow-down-b"></Icon>
					        </a>
					        <Dropdown-menu slot="list"  class="nav-item">
					            <Dropdown-item name="/organizationManage">组织关系转接</Dropdown-item>
					            <Dropdown-item name="/recruitMembers">发展党员</Dropdown-item>
					            <!-- <Dropdown-item name="/recruitMembers">发展党员审核</Dropdown-item> -->
					            <Dropdown-item name="/interview">介绍信管理</Dropdown-item>
					            <Dropdown-item name="/repeatMembers">重复人员查询</Dropdown-item>
					        </Dropdown-menu>
					    </Dropdown>
					</div>
					<div class="drown-outer start-box box-align">
						<Dropdown trigger="click" style="margin:0 20px" @on-click="routeTo">
					        <a href="javascript:void(0)">
					            统计报表
					            <Icon type="arrow-down-b"></Icon>
					        </a>
					        <Dropdown-menu slot="list"  class="nav-item">
					            <Dropdown-item name="/baseSituation">党建情况</Dropdown-item>
					            <Dropdown-item name=""><router-link class="ivu-dropdown-item" :style="{'padding' : 0 }" :to="{'path': '/countForm/covers/form-5?id='+link}">统计报表</router-link></Dropdown-item>
					            <!-- <Dropdown-item name="/">设计报表</Dropdown-item> -->
					        </Dropdown-menu>
					    </Dropdown>
						<!-- <router-link style="margin:0 20px;" :to="{'path': '/countForm/covers/form-5?id='+link}">统计报表</router-link> -->
					</div>
				    <div class="drown-outer start-box box-align">
				    	<router-link :to="{name : 'adminconfig'}">
				    		<a style="margin:0 20px;">管理员设置</a>
				    	</router-link>
				    </div>
				</div>
				<!-- 用户信息 -->
				<router-link :to="{name : 'mainIndex'}">
					<Dropdown class="info-tips" trigger="hover" style="margin:0 20px;" @on-click="setTo">
				        <div class="start-box box-align" style="height:60px;">
							<img class="avatar" :src="userInfo.user_head" width="32" height="42" alt="" style="border: 1px solid #fff;vertical-align:bottom;">
							<div class="start-box box-orient">
								<p style="font-size: 14px; color:#fff; line-height:20px;">{{userInfo.user_name}}</p>
							</div>
							<Icon type="arrow-down-b" style="margin-left:10px; color: #fff;"></Icon>
						</div>
				        <Dropdown-menu slot="list"  class="nav-item text-center" style="padding: 0;" >
				            <Dropdown-item name="1">
				            	<p style="font-size: 14px; font-weight: bold;">{{userInfo.user_name}}</p>
				            	<p>{{current.full_name}}</p>
				            </Dropdown-item>
				            <Dropdown-item name="2">修改密码</Dropdown-item>
				            <Dropdown-item name="3">切换管理角色</Dropdown-item>
				            <Dropdown-item name="4"><p style="color:#ed3f14;">退出登陆</p></Dropdown-item>
				        </Dropdown-menu>
				    </Dropdown>
				</router-link>
			</div>
		</i-col>
	</Row>
</template>
<script>
	export default {
		name: 'top',
		data() {
			return {
				userInfo:{
				},
				lists: [],
				current: {},
				modal1: false,
				modal2: false,
        		loading: true,
        		OrganizationeForm: {
		          orignpwd: "",
		          pwd: "",
		          newpwd: "",
		        },
		        ruleValidate: {
		          orignpwd: [
		            {required: true, message: '原始密码不能为空', trigger: 'blur'}
		          ],
		          pwd: [
		            {required: true, message: '新密码不能为空', trigger: 'blur'}
		          ], 
		          newpwd: [
		            {required: true, message: '确定新密码不能为空', trigger: 'blur'}
		          ], 
		        },
		        OrganizationeForm2: {
		          radio: "",
		        },
		        ruleValidate2: {
		        }
			}
		},
		computed: {
			link() {
				return this.$store.state.remberId;
			}
		},
		components: {
		},
		methods: {
			handleSubmit(name) {
		        let obj = this.OrganizationeForm
		        let that = this;  
		        if (that.OrganizationeForm['pwd'] !== that.OrganizationeForm['newpwd']) {
		        	that.$Message.error('新密码和确认新密码不一致');
		        	setTimeout(() => {
                        that.loading = false;
                        that.$nextTick(() => {
                            that.loading = true;
                        });
                    }, 1000);
		        	return;
		        };   
		        this.$refs[name].validate((valid) => {
		          if (valid) {
		            let qs = require('qs');
		            this.axios({
		                method: 'post',
		                url: '/v1/user/modify-password',
		                data: qs.stringify({old: that.OrganizationeForm['orignpwd'], new: that.OrganizationeForm['pwd']})
		            })
		            .then(res => {
		                let needData = res.data;
		                if (needData.code == 200) {
		                    that.$Message.success('密码修改成功，请重新登陆');
		                    that.$Modal.remove()
		                    setTimeout(function(args) {
		                      that.$router.push({name: 'login'});
		                    }, 1000)
		                } else {
		                    setTimeout(() => {
		                        that.loading = false;
		                        that.$nextTick(() => {
		                            that.loading = true;
		                        });
		                    }, 1000);
		                    that.$Message.error(needData.msg);
		                }
		            })
		            .catch(err => {
		                this.$Message.error('网络请求异常');
		                setTimeout(() => {
		                    that.loading = false;
		                    that.$nextTick(() => {
		                        that.loading = true;
		                    });
		                }, 1000);
		            })
		          } else {
		            this.$Message.error('表单验证失败!');
		            setTimeout(() => {
		                that.loading = false;
		                that.$nextTick(() => {
		                    that.loading = true;
		                });
		            }, 1000);
		          }
		        })
		    },
		    handleSubmit2(name) {
		    	let that = this;      
	            let qs = require('qs');		        
	            this.axios({
	                method: 'get',
	                url: '/v1/user/switch-range',
	                params: {dept_id: that.OrganizationeForm2['radio']}
	            })
	            .then(res => {
	                let needData = res.data;
	                if (needData.code == 200) {
	                    that.$Message.success('切换成功');
	                    that.$Modal.remove()
	                    setTimeout(function(args) {	
				    		window.location.reload();
				    	}, 1000);
	                } else {
	                    setTimeout(() => {
	                        that.loading = false;
	                        that.$nextTick(() => {
	                            that.loading = true;
	                        });
	                    }, 1000);
	                    that.$Message.error(needData.msg);
	                }
	            })
	            .catch(err => {
	                this.$Message.error('网络请求异常');
	                setTimeout(() => {
	                    that.loading = false;
	                    that.$nextTick(() => {
	                        that.loading = true;
	                    });
	                }, 1000);
	            })    
		    },
		    cancel() {
		        let that = this;
		        this.$Modal.remove()
		    },
			setTo(name) {
				switch(parseInt(name)) {
					case 1: break;
					case 2: 
						this.modal1 = true;
						break;
					case 3: 
						this.modal2 = true;
						break;
					case 4: this.logout();break;
				}
			},
			logout() {
				let that = this;
	           	this.axios({
	                method: 'get',
	                url: '/v1/user/logout',
	            })
	            .then(res => {
	                let needData = res.data;
	                if (needData.code == 200) {
	                    that.$Message.success('退出成功');
	                    that.$router.push('/login');
	                } else {
	                    that.$Message.error(needData.msg);
	                }
	            })
	            .catch(err => {
	            	console.log(err)
	                this.$Message.error('网络请求异常');
	            }) 
			},
			getUserInfo(){
				var that = this;
				this.axios({
					method: 'post',
					url: '/v1/user/logininfo-base',
				})
				.then(res => {
					let _data = res.data;
					if(_data.code == 200) {
						let data = _data.data;
						that.userInfo = Object.assign(data);
						that.lists = data.range_all;
						that.current = data.range_current;
						that.OrganizationeForm2['radio'] = that.current['id']
					}
				})
				.catch(error => {
					console.log('请求失败');
				})
			},
			routeTo(path) {
				if (path == '') {
					return;
				};
				this.$router.push({path: path})
			},
			getList() {
				var that = this;
				this.axios({
					method: 'get',
					url: '/v1/auth-manage/list',
				})
				.then(res => {
					let _data = res.data;
					if(_data.code == 200){
						let data = _data.data;
						that.userInfo.real_name = data.real_name;
					}
				})
				.catch(error => {
					console.log('请求失败');
				})
			},
		},
		created() {

		},
		mounted() {
			this.getUserInfo();
	    },
	}
</script>
<style>
	.info-tips .ivu-select-dropdown {
		padding: 0px;
	}
	.text-right{
		text-align: right;
	}
	.layout-header{
		overflow: hidden;
		text-align: center;
	}
	.layout-header a{
		display:inline-block;
		margin-top: 10px;
	}
	.layout-header-fav{
		font-size: 0;
		margin-top: 15px;
		padding-right: 20px;
	}

	
	.layout-header-fav img{
		display: inline-block;
		width: 30px;
		height: 30px;
		border-radius: 50%;
		margin-right: 20px;
		vertical-align: middle;
	}
	.layout-header-fav p{
		display: inline-block;
		font-size: 14px;
		vertical-align: middle;
	}
	.layout-header-fav a{
		font-size: 14px;
		color: #4b4b4b;
		display: inline-block;
		margin-left: 15px;
		vertical-align: middle;
	}
	.avatar{
		margin-right: 10px;
	}
</style>