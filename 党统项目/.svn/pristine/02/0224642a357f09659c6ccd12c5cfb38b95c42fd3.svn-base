<!--班子成员新增的弹窗-->
<template>
  <div class="TeamMember">
    <Modal
      v-model="modal1"
      title="班子成员维护"
      width="950"
      :loading="loading"
      :mask-closable=false
       @on-ok="handleSubmit('memberFormItem')"
      @on-cancel="cancel">
      <Row>
        <Col span="15">
          <Form :model="memberFormItem" ref="memberFormItem" :label-width="110" :rules="ruleValidate">
            <FormItem label="类型">
              <RadioGroup v-model="type">
                <Radio :disabled="isEdit" label="0">选择内部人员</Radio>
                <Radio :disabled="isEdit" label="1">选择外部人员</Radio>
                <Radio :disabled="isEdit" label="2">手动填写</Radio>
              </RadioGroup>
            </FormItem>
            <FormItem v-if="type=='0'" label="姓名0：" prop="name">
              <Tag>王叙淳党员</Tag>
              <Button @click.stop="isInside=true" type="dashed" style="width: 100%;">
                <Icon size="60px" type="plus" :style="{'marginRight':'5px'}"></Icon>
                <label>添加</label>
              </Button>
            </FormItem>
            <FormItem v-if="type=='1'" label="姓名1：" prop="name">
              <Tag>王叙淳党员</Tag>
              <Button @click.stop="isOutside=true" type="dashed" style="width: 100%;">
                <Icon size="60px" type="plus" :style="{'marginRight':'5px'}"></Icon>
                <label>添加</label>
              </Button>
            </FormItem>
            <FormItem v-if="type=='2'" label="姓名：" prop="name">
              <Input v-model="memberFormItem.name"  :disabled="isEdit" placeholder="请输入"></Input>
            </FormItem>
            <FormItem label="职务名称：" prop="dutys">
              <Select v-model="memberFormItem.dutys" multiple :filterable="false" :disabled="isDisable" placeholder="请选择" :transfer=true>
                <Option v-for="item in dutyList2" :value="item.id" :key="item.id">{{item.name}}</Option>
                <!--<Button @click.stop="cliBtn" class="no-cursor" size="small" style="margin: 0 auto;display: block;">加载更多....</Button>-->
              </Select>
            </FormItem>
            <FormItem label="职务级别：" prop="duty_level">
              <Select v-model="memberFormItem.duty_level" :disabled="isDisable" placeholder="请选择" :transfer=true>
                <Option v-for="item in duty_level_list" :key="item.id" :value="item.id">{{item.name}}</Option>
              </Select>
            </FormItem>



            <FormItem label="批准任职日期：" prop="duty_time">
              <Row>
                <Col span="24">
                  <DatePicker type="date" placeholder="选择日期"  format="yyyyMMdd" :disabled="isDisable" v-model="memberFormItem.duty_time"></DatePicker>
                </Col>
              </Row>
            </FormItem>
            <FormItem label="职务说明" prop="duty_remark">
              <Input v-model="memberFormItem.duty_remark" type="textarea" :disabled="isDisable" :autosize="{minRows: 4,maxRows: 10}" placeholder="请输入..."></Input>
            </FormItem>

          </Form>
        </Col>
      </Row>
    </Modal>
    <TeamMemberInside v-if="isInside" @setCancer="setCancer"></TeamMemberInside>
    <TeamMemberOutside v-if="isOutside" @setOutCancer="setOutCancer"></TeamMemberOutside>
  </div>
</template>
<script type="text/ecmascript-6">
  import TeamMemberInside from '@/components/pop/TeamMemberInside.vue'
  import TeamMemberOutside from '@/components/pop/TeamMemberOutside.vue'
  export default {
    data () {
      return {
        modal1: true,//是否显示弹窗
        isInside:false,//内部人员添加
        isOutside:false,//外部人员添加
        loading:true,
        isDisable:false,//是否禁止表单输入
        type:'2',//选择的类型
        dutyList:[],//保存职务类型截取后的数据
        dutyList2:[],//职务类型的全部数据
        duty_level_list:[],//职务级别list数据
        isCheck:false,//是否为查看弹窗
        isEdit:false,//编辑状态的禁止姓名和类型的更改
        index:1,
        userId:'',//人员id判断是否为编辑有 此id为编辑 无此id为新增
        memberFormItem: {  //form的绑定
          name:'',//姓名
          dutys:[],//职务名称
          duty_level:'',//级别
          duty_time:'',//批准时间
          duty_remark:''//职务说明
        },
        ruleValidate: {
          name: [
            {required: true, message: '姓名不能为空', trigger: 'blur'}
          ],
          dutys: [
            {required: true,type:'array', message: '职务名称不能为空', trigger: 'change'},
          ],
          duty_level: [
            {required: true, message: '职务级别不能为空', trigger: 'change'},
          ],
          duty_time:[
            {required: true,type:'date', message: '任职日期不能为空', trigger: 'change'}
          ],
        }
      }
    },
    components:{
      TeamMemberInside,//内部人员组件
      TeamMemberOutside//外部人员组件
    },
    methods: {
      handleSubmit(name) {
        this.$refs[name].validate((valid) => {
          if (valid) {
            //判断是否为查看 不是查看模块进if
            if(!this.isCheck){
              let qs = require('qs');
              let dept_id = this.$route.params.id;//党组织id
              let id=this.$route.params.userId;//成员id
              var url =''
              //判断是否有
              if (id==undefined ||id=='undefined' || id==''){
                url='/v1/leader/add-leader';
              }else{
                url='/v1/leader/modify-leader';
              }
              console.log(dept_id,id,url);
              let that = this;
              //批准时间  10位时间戳
              let duty_time=that.memberFormItem.duty_time.getTime()/1000
              this.axios({
                method: 'post',
                  url:url,
                  data: qs.stringify({
                  dept_id: dept_id,
                  id:id,
                  name:that.memberFormItem.name,
                  dutys:that.memberFormItem.dutys,
                  duty_level:that.memberFormItem.duty_level,
                  duty_time:duty_time,
                  duty_remark:that.memberFormItem.duty_remark,
                })
              })
              .then((res)=>{
                let needData=res.data;
                if(needData.code='200'){
                  this.$Message.success('提交成功!');
                  this.modal1=false;
                  this.$router.go(-1)
                }else {
                  this.loading=false;
                  this.$Message.error(needData.msg);
                  setTimeout(() => {
                    this.loading=true;
                    //this.$router.go(-1)
                  }, 20);
                }
              })
            }else {
              this.modal1=false;
              this.$router.go(-1)
            }

          } else {
            this.loading=false;
            this.$Message.error('表单验证失败!');
            setTimeout(() => {
              this.loading=true;
              //this.$router.go(-1)
          }, 20);
          }
        })
      },
      cancel () {
        this.$Message.info('点击了取消');
        this.$router.go(-1);
      },
      setCancer() {
        this.isInside = false;
      },
      //外部人员弹窗控制
      setOutCancer() {
        this.isOutside = false;
      },
      //获取职务名称list
      getDuty(){
        let that=this;
        this.axios({
            method: 'get',
            url: '/v1/dictionary/get-list-by-type',
            params: {
              type: 'D03052',
            }
          })
          .then(res => {
            let needData = res.data;
            if (needData.code == 200) {
              that.dutyList2=needData.data;
            } else {

            }
          })
        //获取党内职务级别
        this.axios({
            method: 'get',
            url: '/v1/dictionary/get-list-by-type',
            params: {
              type: 'A02021',
            }
          })
          .then(res => {
            let needData = res.data;
            if (needData.code == 200) {
              that.duty_level_list=needData.data;

            } else {
              that.$Message.error(msg);
            }
          })
      },
      getRender(){



        let id=this.$route.params.userId;//人员id
        this.userId=id;
        let state=this.$route.params.state;//0 查看  1编辑  2新增
        let that = this;
        let url=""
        if(state=='0'){
          that.isDisable=true;
          that.ruleValidate={};
          that.lodding=false;
          that.isCheck=true;
          that.isEdit=true;

        }else if(state=='1'){
          that.isDisable=false;
          that.isEdit=true;

        }
          this.axios({
              method: 'get',
              url: '/v1/leader/get-dept-leader',
              params: {
                id: id,
                opt:1
              }
            })
            .then(res => {
              let needData = res.data;
              if (needData.code == 200) {
                //处理时间戳
                let duty_time = new Date(needData.data.duty_time*1000);
                that.memberFormItem.name=needData.data.name;//赋值姓名
                that.memberFormItem.dutys=needData.data.dutys;//赋值职务
                that.memberFormItem.duty_level=needData.data.duty_level//赋值职务级别
                that.memberFormItem.duty_time=duty_time;//赋值时间
                that.memberFormItem.duty_remark=needData.data.duty_remark//赋值描述
              } else {
                that.$Message.error(needData.msg);
              }
            })
            .catch(err => {
              this.$Message.error('网络请求异常');
            })
      },
      submit(){

      }
    },
    mounted(){
      this.getRender();
      this.getDuty();
    }
  }
</script>
<style scrop>
  .TeamMember{
    width: 100%;
    height: 100%;
    position: absolute;
  }
  .no-cursor{
    cursor: pointer !important;
  }
</style>
